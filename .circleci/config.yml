version: 2
jobs:
    build:
        docker:
        - image: andreacensi/mcdp_books:duckuments@sha256:307d478c8cedaff574e4a94303dae779547a513bd0641e3d4c236a5206b6c77b
          environment:
              COLUMNS: 160
              TERM: xterm-256color
              EXTRA_MCDP_RENDER_OPTIONS: --ignore_ref_errors

        resource_class: large
        - run:
            name: Install Git LFS
            command: |
              curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
              apt-get update
              apt-get install -y git-lfs openssh-client
              git lfs install
              mkdir -p ~/.ssh
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts
              ssh git@github.com git-lfs-authenticate "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" download
              git lfs pull
        - restore_cache:
        - run:
            name: Download resources
            command: |
            git submodule sync --recursive
            git submodule update --init --recursive

        - run:
            name: Compile
            command: make compile-native-ci

        - run:
            name: Link check
            command: |
                . /project/deploy/bin/activate && make linkcheck || true

        - run:
            when: always
            name: Package artifacts
            command:  |
                find duckuments-dist -name '*.old' -delete
                make package-artifacts

        - store_artifacts:
              path: out/package.tgz
              destination: out/package.tgz


        - store_artifacts:
              path: duckuments-dist
              destination: duckuments-dist


        - test-results-store:
            path: duckuments-dist/junit
